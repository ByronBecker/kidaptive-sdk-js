(function(e){"use strict";var t={HOST_PROD:"https://service.kidaptive.com/v3",HOST_DEV:"https://develop.kidaptive.com/v3",ENDPOINTS:{APP:"/app/me",GAME:"/game",PROMPT:"/prompt",CATEGORY:"/category",SUB_CATEGORY:"/sub-category",INSTANCE:"/instance",PROMPT_CATEGORY:"/prompt-category",SKILLS_FRAMEWORK:"/skills-framework",SKILLS_CLUSTER:"/skills-cluster",SKILLS_DOMAIN:"/skills-domain",DIMENSION:"/dimension",LOCAL_DIMENSION:"/local-dimension",ITEM:"/item",LEARNER:"/learner",ABILITY:"/ability",LOCAL_ABILITY:"/local-ability",INSIGHT:"/insight",INGESTION:"/ingestion",USER:"/user/me",LOGOUT:"/user/logout"},ALP_EVENT_VERSION:"3.0"};"use strict";var r=function(e,t){var r=new Error(t);Object.getOwnPropertyNames(r).map(function(e){Object.defineProperty(this,e,Object.getOwnPropertyDescriptor(r,e))}.bind(this));this.type=e};r.prototype=Object.create(Error.prototype);r.prototype.constructor=r;r.prototype.name="KidaptiveError";r.prototype.toString=function(){return this.name+" ("+this.type+"): "+this.message};r.KidaptiveErrorCode={OK:"OK",GENERIC_ERROR:"GENERIC_ERROR",NOT_IMPLEMENTED:"NOT_IMPLEMENTED",INVALID_PARAMETER:"INVALID_PARAMETER",ILLEGAL_STATE:"ILLEGAL_STATE",INIT_ERROR:"INIT_ERROR",MISSING_DELEGATE:"MISSING_DELEGATE",AUTH_ERROR:"AUTH_ERROR",NOT_LOGGED_IN:"NOT_LOGGED_IN",LEARNER_NOT_FOUND:"LEARNER_NOT_FOUND",TRIAL_NOT_OPEN:"TRIAL_NOT_OPEN",URI_NOT_FOUND:"URI_NOT_FOUND",RECOMMENDER_ERROR:"RECOMMENDER_ERROR",API_KEY_ERROR:"API_KEY_ERROR",WEB_API_ERROR:"WEB_API_ERROR"};"use strict";var n=function(e,r){this.host=r?t.HOST_DEV:t.HOST_PROD;this.apiKey=e};n.USER_ENDPOINTS=[t.ENDPOINTS.USER,t.ENDPOINTS.LEARNER,t.ENDPOINTS.ABILITY,t.ENDPOINTS.LOCAL_ABILITY,t.ENDPOINTS.INSIGHT];n.CACHE_EXCLUDE_METHODS=["POST"];n.CACHE_EXCLUDE_ENDPOINTS=[t.ENDPOINTS.INSIGHT];(function(){var e=function(t,r){if(typeof t==="object"){if(t instanceof Boolean||t instanceof Number||t instanceof String){t=t.valueOf()}}switch(typeof t){case"object":if(t instanceof Array){return"["+t.map(function(t){return e(t,true)}).join(",")+"]"}else{return"{"+Object.keys(t).sort().map(function(r){var n=e(t[r]);return n===undefined?undefined:[JSON.stringify(r),n].join(":")}).filter(function(e){return e!==undefined}).join(",")+"}"}case"boolean":case"number":case"string":return JSON.stringify(t);default:return r?JSON.stringify(null):undefined}};n.prototype.ajax=function(t,i,o){var a={headers:{"api-key":this.apiKey},xhrFields:{withCredentials:true}};a.method=t;a.url=this.host+i;if(a.method==="GET"){a.data=o}else if(a.method==="POST"){a.contentType="application/json";a.data=JSON.stringify(o)}else{return $.Deferred().reject(new r(r.KidaptiveErrorCode.INVALID_PARAMETER,"Method must be 'GET' or 'POST'"))}var s=n.CACHE_EXCLUDE_METHODS.indexOf(t)<0&&n.CACHE_EXCLUDE_ENDPOINTS.indexOf(i)<0?sjcl.hash.sha256.hash(e(a)).map(function(e){var t=(e+Math.pow(2,31)).toString(16);return"0".repeat(8-t.length)+t}).join("")+(n.USER_ENDPOINTS.indexOf(i)>=0?".alpUserData":".alpAppData"):undefined;return $.ajax(a).then(function(e){if(s){try{localStorage.setItem(s,JSON.stringify(e))}catch(e){console.log("Warning: ALP SDK unable to write to localStorage. Cached data may be inconsistent or out-of-date")}}return e},function(e){if(e.status===400){throw new r(r.KidaptiveErrorCode.INVALID_PARAMETER,e.responseText)}else if(e.status===401){n.deleteUserData();if(n.USER_ENDPOINTS.indexOf(i)<0){n.deleteAppData()}throw new r(r.KidaptiveErrorCode.API_KEY_ERROR,e.responseText)}else if(e.status){throw new r(r.KidaptiveErrorCode.WEB_API_ERROR,e.responseText)}else{var t=localStorage.getItem(s);if(t){return t==="undefined"?undefined:JSON.parse(t)}throw new r(r.KidaptiveErrorCode.GENERIC_ERROR,"HTTP Client Error")}})};n.deleteUserData=function(){Object.keys(localStorage).forEach(function(e){if(e.endsWith(".alpUserData")){localStorage.removeItem(e)}})};n.deleteAppData=function(){Object.keys(localStorage).forEach(function(e){if(e.endsWith(".alpAppData")){localStorage.removeItem(e)}})}})();"use strict";var i=function(e){this.sdk=e};i.prototype.refreshUser=function(){return this.sdk.httpClient.ajax("GET",t.ENDPOINTS.USER).then(function(e){this.currentUser=e;return e}.bind(this))};i.prototype.logoutUser=function(){return this.sdk.httpClient.ajax("POST",t.ENDPOINTS.LOGOUT).always(function(){this.currentUser=undefined}.bind(this))};"use strict";(function(){var o=$.Deferred().resolve();var a=undefined;var s=function(e){var t=o.then(e);o=t.then(function(){},function(){});return t};var E=function(e){return e===undefined?e:JSON.parse(JSON.stringify(e))};var u=function(e,o,a){var s=$.Deferred().resolve().then(function(){if(!e){throw new r(r.KidaptiveErrorCode.INVALID_PARAMETER,"Api key is required")}if(!o){o={}}o.version=o.version||"";o.build=o.build||"";a=a||{};this.httpClient=new n(e,a.dev);return this.httpClient.ajax("GET",t.ENDPOINTS.APP).then(function(e){if(o.version<e.minVersion){throw new r(r.KidaptiveErrorCode.INVALID_PARAMETER,"Version >= "+e.minVersion+" required. Provided "+o.version)}e.version=o.version;e.build=o.build;this.appInfo=e;this.userManager=new i(this)}.bind(this)).then(function(){return this}.bind(this))}.bind(this));s.then(function(){}).then(function(){});return s};var f=function(e,t,n){return s(function(){if(!a){return new u(e,t,n).then(function(e){a=e;return this}.bind(this))}else if(e||t||n){throw new r(r.KidaptiveErrorCode.ILLEGAL_STATE,"SDK already initialized")}return this}.bind(this))};var d=function(e){if(e.type===r.KidaptiveErrorCode.API_KEY_ERROR){return this.logoutUser().then(function(){throw e})}throw e};f.prototype.getAppInfo=function(){return E(a.appInfo)};f.prototype.getCurrentUser=function(){return E(a.userManager.currentUser)};f.prototype.refreshUser=function(){return a.userManager.refreshUser().then(E,d.bind(this))};f.prototype.logoutUser=function(){return a.userManager.logoutUser().always(function(){n.deleteUserData()})};e.KidaptiveError=r;e.KidaptiveConstants=t;e.init=function(e,t,r){return new f(e,t,r)}})()})(typeof KidaptiveSdk=="undefined"?KidaptiveSdk={}:KidaptiveSdk);
